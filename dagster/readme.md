# Dagster orchestration prototype

This is a prototype of dagster orchestration to demonstrate:

Step (1) Ingestion of sample local csv file and loading of sample table to Bigquery using Meltano

Step (2) GX validation of the Olist tables in Bigquery at brazilian-e-commerce-team-3.BET_Team3

Step (3) Transformation to sample dim and fact table using dbt

Step (4) GX validation of Olist dim and fact tables in Bigquery at brazilian-e-commerce-team-3.BET_Team3

Step (1) and (3) currently uses BQ lkk-dsai.GX_Meltano_Test and lkk-dsai.GX_DBT_Test which are accessible by the author's BQ service account.

They can be replaced by actual Meltano ingestion/loading of data tables to BQ Brazilian-e-commerce-team-3.BET_Team3 and also DBT transformation to create the dim and fact tables.

Step (2) and (4) are validating the data, dim and fact tables already in BQ Brazilian-e-commerce-team-3.BET_Team3

## Important notes:
### 1) Meltano
1.1) meltano.yml:

1.1.1) Extractor:

a) customer_100.csv is provided as the csv to be used by extractor tap-csv and has customer_id as key.

b) Replace path: (currently full local path where csv file is located)

1.1.2) Loader:

a) Replace project (currently lkk-dsai)

b) Replace dataset (currently GX_Meltano_Test)

c) Replace credentials_path (currently JSON from service account that can access lkk-dsai)

*** Bigquery loader requires the JSON from the service account that can access the BQ project and dataset ***


### 2) DBT
2.1) /dagster/GX_DBT_Test/profiles.yml:

a) Replace project (currently lkk-dsai)

b) Replace dataset (currently GX_DBT_Test)

c) Replace keyfile (currently JSON from service account that can access lkk-dsai)

*** Make sure JSON in the keyfile is from the service account that can access the BQ project and dataset ***

2.2) /dagster/GX_DBT_Test/dbt_project.yml:

a) Replace dataset(currently GX_DBT_Test)

b) Replace schema (currently dim_customer_100)

2.3) /dagster/GX_DBT_Test/models/dim_customer_100.sql

a) select data from lkk-dsai.GX_Meltano_Test.customer_100 which was created from 1.1.2 by Meltano. Change the source if required.

2.4) /dagster/GX_DBT_Test/models/schema.yml

name must match the schema in dbt_project.yml. 

Columns are defined in the lkk-dsai.GX_Meltano_Test.customer_100.  

### 3) GX
3.1) /dagster/gx/dataset/gx_table_validation.py

Called by dagster as a sub-process to validate the tables in brazilian-e-commerce-team-3.BET_Team3 dataset that was generated by Meltano.

Use /dagster/gx/gx_olist_validation.py to run the GX checkpoint

3.2) /dagster/gx/dim/gx_dim_fact_validation.py

Called by dagster as a sub-process to validate the dim and fact tables in brazilian-e-commerce-team-3.BET_Team3 dataset that was generated by DBT.

Use /dagster/gx/gx_olist_validation.py to run the GX checkpoint

### 4) Dagster
Uses the 4 assets to form this lineage: meltano_csv_to_bigquery -> GX_validate_meltano -> dbt_run -> GX_validate_dbt

4.1) /dagster/my_dagster_project/my_dagster_project/assets.py

Defines the 4 assets used in the lineage.  Uses sub-process to execute.

4.1.1) meltano_csv_to_bigquery: 

Execute "meltano run tap-csv target-bigquery" from the full path defined in cwd.  

Replace cwd with the full path of Meltano working directory (<your path>/dagster/GX_Meltano_Test).

4.1.2) GX_validate_meltano:

It is dependent on meltano_csv_to_bigquery to be materialised.

Execute "python gx_table_validation.py" from the full path defined in cwd.

Replace cwd with the full path to gx_table_validation.py (<your path>/dagster/gx/dataset).

4.1.3) run_dbt:

It is dependent on GX_validate_meltano to be materialised.

Execute "dbt run --project-dir /Users/luikk/Brazilian-E-Commerce-Team-3-Org/dagster/GX_DBT_Test"

Replace the path with "<your path>/dagster/GX_DBT_Test"

Replace cwd with the full path to DBT working directory (<your path>/dagster/GX_DBT_Test).

4.1.4) GX_validate_dbt:

It is dependent on run_dbt to be materialised.

Execute "python gx_dim_fact_validation.py" from the full path defined in cwd.

Replace cwd with the full path to gx_dim_fact_validation.py (<your path>/dagster/gx/dim).

4.2) /dagster/my_dagster_project/my_dagster_project/__init__.py

Import the 4 assets from assets.py and define them for use by dagster

# Running Dagster:
conda activate elt

cd my_dagster_project (change to your dagster project path: "<your path>/dagster/my_dagster_project")

dagster dev

<open browser http://127.0.0.1:3000>

<Assets->View Lineage->Materialised all>

Author: Lui KK

Version v1.0

Date: 20 Jun 2025
